#!/system/bin/sh

set -o errexit

HOME=/data/data/net.nzbget.nzbget
PATH=$HOME/xbin:$PATH
INSTALLER=/sdcard/data/nzbget/installer/nzbget-bin-android.run
CONFIGFILE=$HOME/nzbget/nzbget.conf

cd $HOME

SetupBusybox()
{
	echo "Preparing busybox tools"
	mkdir -p xbin
	cd xbin
	cp ../lib/libbusybox.so ./busybox
	./busybox --install -s .
	cd ..
}

Configure()
{
	sed -e 's:^MainDir=.*:MainDir=/sdcard/data/nzbget:' -i $CONFIGFILE
	sed -e 's:^ScriptDir=.*:ScriptDir=/sdcard/data/nzbget/scripts:' -i $CONFIGFILE
	sed -e 's:^LockFile=.*:LockFile=${AppDir}/nzbget.lock:' -i $CONFIGFILE
}

Install()
{
	echo "Installing daemon"

	SetupBusybox

	if test -f $CONFIGFILE; then
		CONFIG_EXISTS=yes
	fi

	echo "Installing daemon package"
	sh $INSTALLER --destdir $HOME/nzbget
	if test $? -ne 0; then
		echo "Installation failed"
		exit 1
	fi

	echo "Installation successful"

	if test "$CONFIG_EXISTS" = ""; then
		Configure
		echo "Configuration successful"
	fi
}

Start()
{
	echo "Starting daemon"
	$HOME/nzbget/nzbget -c $HOME/nzbget/nzbget.conf -D
}

Stop()
{
	echo "Stopping daemon"
	$HOME/nzbget/nzbget -c $HOME/nzbget/nzbget.conf -Q
}

Remove()
{
	echo "Removing daemon"
	$HOME/nzbget/nzbget -c $HOME/nzbget/nzbget.conf -Q || echo ""
	rm -r nzbget
}

case $1 in
	install)
		Install
		;;
	remove)
		Remove
		;;
	start)
		Start
		;;
	stop)
		Stop
		;;
esac
